<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Local Password Vault</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121935;
      --panel-2: #0e1530;
      --text: #e7ecff;
      --muted: #a8b3d9;
      --accent: #7c9cff;
      --accent-2: #5df2d6;
      --danger: #ff6b6b;
      --warn: #ffd166;
      --ok: #95f985;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text); background: radial-gradient(1200px 600px at 10% 10%, #111944, transparent 60%), radial-gradient(1000px 500px at 100% 0%, #0d163a, transparent 60%), var(--bg);
      overflow: hidden;
    }
    a { color: var(--accent-2); text-decoration: none; }

    /* Nice scroll for long panels */
    .scroll { overflow: auto; scrollbar-width: thin; }
    .scroll::-webkit-scrollbar { width: 10px; height: 10px; }
    .scroll::-webkit-scrollbar-thumb { background: #2b355f; border-radius: 999px; }

    /* Layout */
    .wrap { height: 100%; display: grid; place-items: center; padding: 24px; }
    .card { width: min(980px, 96vw); background: linear-gradient(180deg, var(--panel), var(--panel-2)); border: 1px solid #202b59; border-radius: var(--radius); box-shadow: var(--shadow); position: relative; overflow: hidden; }

    /* Header */
    .header { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 18px 22px; border-bottom: 1px solid #1d2852; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0)); }
    .brand { display: flex; align-items: center; gap: 12px; font-weight: 700; letter-spacing: .4px; }
    .brand .logo { width: 34px; height: 34px; border-radius: 10px; background: conic-gradient(from 0deg, var(--accent), var(--accent-2), var(--accent)); filter: drop-shadow(0 4px 14px rgba(124,156,255,.35)); animation: spin 8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Buttons */
    .btn { --bgc: #1a2455; --fg: var(--text); --ring: rgba(124,156,255,.45);
      appearance: none; border: 0; padding: 10px 14px; border-radius: 12px; background: var(--bgc);
      color: var(--fg); font-weight: 600; cursor: pointer; transition: transform .06s ease, box-shadow .2s ease, background .2s ease, opacity .2s ease; box-shadow: 0 6px 16px rgba(0,0,0,.25), inset 0 -2px 0 rgba(255,255,255,.06);
      display: inline-flex; align-items: center; gap: 10px; }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 22px rgba(0,0,0,.3), 0 0 0 6px var(--ring); }
    .btn:active { transform: translateY(0); }
    .btn.ghost { background: transparent; border: 1px solid #273165; }
    .btn.accent { --bgc: linear-gradient(180deg, #2a3d9a, #1f2b73); }
    .btn.warn { --bgc: #5a3f00; }
    .btn.danger { --bgc: #4a1520; }
    .btn.small { padding: 8px 10px; border-radius: 10px; font-size: 13px; }

    /* Inputs */
    .field { display: grid; gap: 8px; }
    .label { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: .12em; }
    .input, textarea, select { width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid #253066; background: #0b1140; color: var(--text); outline: none; box-shadow: inset 0 -2px 0 rgba(255,255,255,.03); transition: border .2s ease, background .2s ease; }
    .input:focus, textarea:focus, select:focus { border-color: #3850c5; background: #0a123f; }
    textarea { min-height: 90px; resize: vertical; }

    /* Sections */
    .body { display: grid; grid-template-columns: 280px 1fr; min-height: 520px; }
    .left { border-right: 1px solid #1d2852; padding: 16px; display: grid; grid-template-rows: auto auto 1fr auto; gap: 14px; }
    .right { padding: 18px; display: grid; grid-template-rows: auto auto 1fr; gap: 14px; }

    .panel { background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)); border: 1px solid #1d2852; border-radius: 14px; padding: 12px; }

    .profile-list { display: grid; gap: 8px; max-height: 240px; }
    .profile { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 10px 12px; border-radius: 12px; border: 1px solid transparent; background: #0b1140; cursor: pointer; transition: background .2s ease, border .2s ease, transform .06s ease; }
    .profile:hover { background: #0d1349; }
    .profile.active { border-color: #4053b7; background: #101955; }

    .list { display: grid; gap: 10px; }
    .item { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; padding: 12px; border: 1px solid #22306b; border-radius: 12px; background: #0b1140; }
    .item .meta { display: flex; align-items: center; gap: 10px; }
    .badge { font-size: 11px; padding: 4px 8px; border-radius: 999px; border: 1px solid #29408f; color: #c6d3ff; background: #0c1545; }
    .pill { font-size: 11px; padding: 4px 8px; border-radius: 999px; border: 1px solid #2d5f4f; color: #d6ffee; background: #0c2f26; }

    .toolbar { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .spacer { flex: 1; }

    .empty { text-align: center; padding: 40px 16px; color: var(--muted); }

    /* Dialog/Modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(5,8,20,.65); opacity: 0; pointer-events: none; transition: opacity .2s ease; }
    .modal-backdrop.show { opacity: 1; pointer-events: auto; }
    .modal { position: fixed; inset: 0; display: grid; place-items: center; transform: scale(.98) translateY(6px); opacity: 0; pointer-events: none; transition: transform .2s ease, opacity .2s ease; }
    .modal.show { transform: none; opacity: 1; pointer-events: auto; }
    .modal .window { width: min(620px, 92vw); background: linear-gradient(180deg, var(--panel), var(--panel-2)); border: 1px solid #22306b; border-radius: 16px; padding: 16px; box-shadow: var(--shadow); }

    /* Auth screens */
    .auth { display: grid; gap: 16px; padding: 20px; }
    .auth .title { font-size: 22px; font-weight: 800; }
    .center { text-align: center; }

    /* Toast */
    .toast { position: fixed; right: 16px; bottom: 16px; display: grid; gap: 10px; }
    .toast .t { padding: 12px 14px; border-radius: 12px; border: 1px solid #22306b; background: #0b1140; box-shadow: var(--shadow); animation: pop .25s ease; }
    @keyframes pop { from { transform: translateY(8px); opacity: 0; } }

    /* Password strength */
    .strength { height: 8px; border-radius: 999px; background: #1a214a; overflow: hidden; }
    .strength > div { height: 100%; width: 0%; background: linear-gradient(90deg, #ff6b6b, #ffd166, #95f985); transition: width .25s ease; }

    /* Search */
    .search { display: flex; gap: 8px; }

    /* Lock screen blur overlay */
    .blur { filter: blur(12px); pointer-events: none; user-select: none; }

    /* Subtle glow ring around focused sections */
    .glow { box-shadow: 0 0 0 2px rgba(124,156,255,.45); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="app">
      <div class="header">
        <div class="brand">
          <div class="logo" aria-hidden></div>
          <div>
            <div style="font-size:15px; opacity:.9">Local Password Vault</div>
            <div style="font-size:12px; color:var(--muted)"><span id="profileTitle">Protected</span></div>
          </div>
        </div>
        <div class="toolbar">
          <button class="btn ghost small" id="btnLock" title="Lock (Esc)">🔒 Lock</button>
          <button class="btn ghost small" id="btnExport">⬇️ Export</button>
          <button class="btn ghost small" id="btnImport">⬆️ Import</button>
          <button class="btn accent small" id="btnNewProfile">➕ New Folder</button>
        </div>
      </div>

      <div class="body" id="mainBody" aria-live="polite">
        <aside class="left scroll">
          <div class="panel">
            <div class="field">
              <label class="label">Search</label>
              <div class="search">
                <input class="input" id="search" placeholder="Find in current folder… (Ctrl/⌘+K)" />
                <button class="btn small" id="btnClearSearch">✖</button>
              </div>
            </div>
          </div>

          <div class="panel profile-list scroll" id="profileList"></div>

          <div class="panel">
            <div class="field">
              <label class="label">Auto‑lock</label>
              <select id="autolock" class="input">
                <option value="0">Never</option>
                <option value="300000">5 minutes</option>
                <option value="900000">15 minutes</option>
                <option value="1800000" selected>30 minutes</option>
              </select>
            </div>
          </div>
        </aside>

        <section class="right scroll">
          <div class="toolbar">
            <div class="spacer"></div>
            <button class="btn accent" id="btnNewItem">➕ New Entry</button>
          </div>

          <div class="panel">
            <div id="currentPath" style="font-size:13px; color:var(--muted); margin-bottom: 8px;">/</div>
            <div class="list" id="itemList"></div>
            <div class="empty" id="emptyState" hidden>
              This folder has no items yet.
            </div>
          </div>
        </section>
      </div>

      <!-- LOGIN / SETUP -->
      <div id="authScreen" class="auth" hidden>
        <div class="title">🔐 Welcome</div>
        <div style="color:var(--muted)">This vault is stored <b>locally</b> in your browser and protected with your master password using AES‑GCM. No data leaves your device.</div>
        <div id="loginForm">
          <div class="field">
            <label class="label">Master password</label>
            <input id="masterPassword" class="input" type="password" placeholder="Enter master password" />
          </div>
          <div class="toolbar">
            <button class="btn accent" id="btnUnlock">Unlock</button>
            <div class="spacer"></div>
            <button class="btn ghost" id="btnGoSetup">First time here? Create vault →</button>
          </div>
        </div>
        <div id="setupForm" hidden>
          <div class="field">
            <label class="label">Create a master password</label>
            <input id="setupPass" class="input" type="password" placeholder="Create a strong password" />
            <div class="strength" aria-hidden><div id="strengthBar"></div></div>
          </div>
          <div class="field">
            <label class="label">Confirm password</label>
            <input id="setupPass2" class="input" type="password" placeholder="Repeat master password" />
          </div>
          <div class="toolbar">
            <button class="btn accent" id="btnCreateVault">Create vault</button>
            <div class="spacer"></div>
            <button class="btn ghost" id="btnBackLogin">← Back to login</button>
          </div>
        </div>
        <div class="center" style="font-size: 12px; color: var(--muted)">Tip: you can export/import the <i>encrypted</i> vault file at any time.</div>
      </div>

      <!-- MODALS -->
      <div class="modal-backdrop" id="backdrop" hidden></div>
      <div class="modal" id="modal" hidden>
        <div class="window">
          <div id="modalContent"></div>
        </div>
      </div>

      <div class="toast" id="toast"></div>
    </div>
  </div>

  <script>
    // ============================
    // Utilities
    // ============================
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    const fmtDate = (ms) => new Date(ms).toLocaleString();

    function uuid() {
      const b = new Uint8Array(16);
      crypto.getRandomValues(b);
      // RFC4122 v4
      b[6] = (b[6] & 0x0f) | 0x40;
      b[8] = (b[8] & 0x3f) | 0x80;
      const h = [...b].map(x => x.toString(16).padStart(2,'0')).join('');
      return `${h.substr(0,8)}-${h.substr(8,4)}-${h.substr(12,4)}-${h.substr(16,4)}-${h.substr(20)}`;
    }

    function toast(msg, type="") {
      const t = document.createElement('div');
      t.className = 't';
      t.textContent = msg;
      if (type === 'error') t.style.borderColor = '#612332';
      if (type === 'ok') t.style.borderColor = '#2a634f';
      $('#toast').appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }

    function confirmDialog({title, message, okText='Confirm', cancelText='Cancel'}) {
      return new Promise((resolve) => {
        openModal(`<div style="display:grid; gap:12px;">
          <div style="font-weight:800; font-size:18px;">${title}</div>
          <div style="color:var(--muted)">${message}</div>
          <div class="toolbar">
            <button class="btn danger" id="mOk">${okText}</button>
            <div class="spacer"></div>
            <button class="btn ghost" id="mCancel">${cancelText}</button>
          </div>
        </div>`);
        $('#mOk').onclick = () => { closeModal(); resolve(true); };
        $('#mCancel').onclick = () => { closeModal(); resolve(false); };
      });
    }

    function passwordStrength(pw) {
      let score = 0;
      if (!pw) return 0;
      const unique = new Set(pw).size;
      const variety = [/[a-z]/, /[A-Z]/, /[0-9]/, /[^\w]/].reduce((s, re) => s + (re.test(pw) ? 1 : 0), 0);
      score += Math.min(10, Math.floor(pw.length/2));
      score += Math.min(6, variety * 2);
      score += Math.min(6, Math.floor(unique/3));
      return Math.min(22, score);
    }

    function generatePassword({length=16, digits=true, symbols=true, upper=true, lower=true}={}) {
      let chars = '';
      if (lower) chars += 'abcdefhijkmnopqrstuvwxyz';
      if (upper) chars += 'ABCDEFGHJKLMNPQRSTUVWXYZ';
      if (digits) chars += '23456789';
      if (symbols) chars += '!@#$%^&*()_+-=[]{};:,.<>/?';
      const a = new Uint32Array(length);
      crypto.getRandomValues(a);
      return [...a].map(n => chars[n % chars.length]).join('');
    }

    // ============================
    // Crypto helpers (Web Crypto API)
    // ============================
    const VAULT_KEY = 'vault.encrypted.v1';
    const META_KEY = 'vault.meta.v1';

    const PBKDF2_ITER = 200_000; // tweakable

    async function deriveKeyFromPassword(password, salt) {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey(
        'raw', enc.encode(password), {name: 'PBKDF2'}, false, ['deriveKey']
      );
      return crypto.subtle.deriveKey(
        {name: 'PBKDF2', salt, iterations: PBKDF2_ITER, hash: 'SHA-256'},
        keyMaterial,
        {name: 'AES-GCM', length: 256},
        false,
        ['encrypt','decrypt']
      );
    }

    async function encryptJson(obj, key) {
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const data = new TextEncoder().encode(JSON.stringify(obj));
      const ct = new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, data));
      return { iv: btoa(String.fromCharCode(...iv)), ct: btoa(String.fromCharCode(...ct)) };
    }

    async function decryptJson(bundle, key) {
      const iv = Uint8Array.from(atob(bundle.iv), c => c.charCodeAt(0));
      const ct = Uint8Array.from(atob(bundle.ct), c => c.charCodeAt(0));
      const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
      return JSON.parse(new TextDecoder().decode(pt));
    }

    // ============================
    // Vault state (in-memory when unlocked)
    // ============================
    let masterKey = null; // CryptoKey
    let vault = null;     // decrypted object
    let activeProfile = null; // string name
    let lastActive = Date.now();

    const defaultVault = () => ({
      version: 1,
      createdAt: Date.now(),
      updatedAt: Date.now(),
      profiles: { 'Default': [] }
    });

    function touch() { lastActive = Date.now(); }

    function setBlur(locked) {
      const main = $('#mainBody');
      if (!main) return;
      if (locked) main.classList.add('blur'); else main.classList.remove('blur');
    }

    async function persistVault() {
      if (!masterKey || !vault) return;
      vault.updatedAt = Date.now();
      const enc = await encryptJson(vault, masterKey);
      localStorage.setItem(VAULT_KEY, JSON.stringify(enc));
      const meta = JSON.parse(localStorage.getItem(META_KEY)||'{}');
      meta.updatedAt = vault.updatedAt;
      localStorage.setItem(META_KEY, JSON.stringify(meta));
    }

    function readMeta() {
      return JSON.parse(localStorage.getItem(META_KEY) || 'null');
    }

    function writeMeta(meta) {
      localStorage.setItem(META_KEY, JSON.stringify(meta));
    }

    async function loadVault(password) {
      const raw = localStorage.getItem(VAULT_KEY);
      const meta = readMeta();
      if (!raw || !meta) throw new Error('No vault found');
      const salt = Uint8Array.from(atob(meta.salt), c => c.charCodeAt(0));
      const key = await deriveKeyFromPassword(password, salt);
      const obj = await decryptJson(JSON.parse(raw), key); // throws if wrong
      masterKey = key;
      vault = obj;
      activeProfile = activeProfile || Object.keys(vault.profiles)[0] || 'Default';
      setBlur(false);
      render();
    }

    async function createVault(password) {
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const key = await deriveKeyFromPassword(password, salt);
      masterKey = key;
      vault = defaultVault();
      activeProfile = 'Default';
      const meta = { version: 1, createdAt: vault.createdAt, updatedAt: vault.updatedAt, iter: PBKDF2_ITER, salt: btoa(String.fromCharCode(...salt)) };
      writeMeta(meta);
      await persistVault();
      setBlur(false);
      render();
    }

    function lockVault() {
      masterKey = null; vault = null; activeProfile = null; setBlur(true);
      $('#authScreen').hidden = false;
      $('#mainBody').hidden = true;
      $('#profileTitle').textContent = 'Locked';
    }

    function ensureUnlocked() {
      if (!vault) throw new Error('Vault is locked');
    }

    // ============================
    // Rendering
    // ============================
    function render() {
      if (!vault) return;
      $('#authScreen').hidden = true;
      $('#mainBody').hidden = false;
      $('#profileTitle').textContent = `${activeProfile} • ${Object.keys(vault.profiles).length} folder(s)`;

      // profiles
      const pl = $('#profileList');
      pl.innerHTML = '';
      Object.keys(vault.profiles).sort((a,b)=>a.localeCompare(b)).forEach(name => {
        const el = document.createElement('div');
        el.className = 'profile' + (name===activeProfile ? ' active' : '');
        el.innerHTML = `<div>📁 ${name}</div><div class="badge">${vault.profiles[name].length}</div>`;
        el.onclick = () => { activeProfile = name; renderItems(); highlight(el); };
        pl.appendChild(el);
      });

      renderItems();
    }

    function renderItems() {
      const items = vault.profiles[activeProfile] || [];
      const q = $('#search').value.trim().toLowerCase();
      $('#currentPath').textContent = `/${activeProfile}${q ? ` — filtering: "${q}"`: ''}`;
      const list = $('#itemList');
      list.innerHTML = '';
      const filtered = q ? items.filter(i => [i.title, i.username, i.url, i.notes].some(v => (v||'').toLowerCase().includes(q))) : items;

      if (!filtered.length) { $('#emptyState').hidden = false; return; }
      $('#emptyState').hidden = true;

      filtered.sort((a,b)=>b.updatedAt - a.updatedAt).forEach(it => {
        const row = document.createElement('div');
        row.className = 'item';
        const masked = '•'.repeat(12);
        row.innerHTML = `
          <div>
            <div class="meta"><span style="font-weight:700">${it.title||'(no title)'} </span>
              ${it.url ? `<a href="${it.url}" target="_blank" rel="noopener" class="badge">open</a>` : ''}
              <span class="pill" title="Updated at">${new Date(it.updatedAt).toLocaleString()}</span>
            </div>
            <div style="font-size:13px; color:var(--muted); margin-top:4px;">👤 ${it.username||'—'} • 🔑 <span data-pw="${it.id}">${masked}</span></div>
          </div>
          <div class="toolbar">
            <button class="btn small" data-action="reveal" data-id="${it.id}">👁️‍🗨️</button>
            <button class="btn small" data-action="copy" data-id="${it.id}">📋 Copy</button>
            <button class="btn small" data-action="edit" data-id="${it.id}">✏️ Edit</button>
            <button class="btn small danger" data-action="del" data-id="${it.id}">🗑️</button>
          </div>`;
        list.appendChild(row);
      });
    }

    function highlight(el) {
      el.classList.add('glow');
      setTimeout(()=>el.classList.remove('glow'), 600);
    }

    // ============================
    // Modals
    // ============================
    function openModal(html) {
      $('#modalContent').innerHTML = html;
      $('#backdrop').hidden = false; $('#modal').hidden = false;
      setTimeout(()=>{ $('#backdrop').classList.add('show'); $('#modal').classList.add('show'); }, 10);
    }
    function closeModal() {
      $('#backdrop').classList.remove('show'); $('#modal').classList.remove('show');
      setTimeout(()=>{ $('#backdrop').hidden = true; $('#modal').hidden = true; $('#modalContent').innerHTML=''; }, 180);
    }

    function itemForm(existing) {
      const data = existing || { id: uuid(), title:'', username:'', password: generatePassword({length:20}), url:'', notes:'' };
      openModal(`<div style="display:grid; gap:14px;">
        <div style="font-weight:800; font-size:18px;">${existing ? 'Edit' : 'New'} entry</div>
        <div class="field"><label class="label">Title</label><input id="f_title" class="input" value="${escapeHtml(data.title)}" /></div>
        <div class="field"><label class="label">Username / Email</label><input id="f_user" class="input" value="${escapeHtml(data.username)}" /></div>
        <div class="field"><label class="label">Password</label>
          <div style="display:flex; gap:8px;">
            <input id="f_pass" class="input" type="text" value="${escapeHtml(data.password)}" />
            <button class="btn small" id="btnGen">🎲</button>
            <button class="btn small" id="btnCopyPass">📋</button>
          </div>
        </div>
        <div class="field"><label class="label">URL</label><input id="f_url" class="input" value="${escapeHtml(data.url)}" /></div>
        <div class="field"><label class="label">Notes</label><textarea id="f_notes" class="input">${escapeHtml(data.notes)}</textarea></div>
        <div class="toolbar">
          <button class="btn accent" id="mSave">${existing ? 'Save changes' : 'Add to folder'}</button>
          <div class="spacer"></div>
          <button class="btn ghost" id="mCancel">Cancel</button>
        </div>
      </div>`);
      $('#btnGen').onclick = () => { $('#f_pass').value = generatePassword({length:20}); toast('New password generated'); };
      $('#btnCopyPass').onclick = async () => { await navigator.clipboard.writeText($('#f_pass').value); toast('Password copied','ok'); };
      $('#mCancel').onclick = closeModal;
      $('#mSave').onclick = async () => {
        ensureUnlocked();
        const entry = { id: data.id, title: $('#f_title').value.trim(), username: $('#f_user').value.trim(), password: $('#f_pass').value, url: $('#f_url').value.trim(), notes: $('#f_notes').value.trim(), updatedAt: Date.now() };
        const list = vault.profiles[activeProfile];
        const ix = list.findIndex(x => x.id===entry.id);
        if (ix>=0) list[ix] = entry; else list.push(entry);
        await persistVault();
        renderItems();
        closeModal();
        toast(existing? 'Saved' : 'Added','ok');
      };
    }

    function profileForm() {
      openModal(`<div style="display:grid; gap:12px;">
        <div style="font-weight:800; font-size:18px;">New folder</div>
        <div class="field"><label class="label">Folder name</label><input id="p_name" class="input" placeholder="e.g. Alice, Work, Family" /></div>
        <div class="toolbar">
          <button class="btn accent" id="mAddProfile">Create</button>
          <div class="spacer"></div>
          <button class="btn ghost" id="mCancel">Cancel</button>
        </div>
      </div>`);
      $('#mCancel').onclick = closeModal;
      $('#mAddProfile').onclick = async () => {
        const name = $('#p_name').value.trim() || 'New Folder';
        if (vault.profiles[name]) { toast('Folder already exists','error'); return; }
        vault.profiles[name] = [];
        activeProfile = name;
        await persistVault();
        render();
        closeModal();
        toast('Folder created','ok');
      };
    }

    // ============================
    // Event wiring
    // ============================
    $('#btnNewItem').onclick = () => { try { ensureUnlocked(); itemForm(); } catch(e){ toast('Unlock first','error'); } };
    $('#btnNewProfile').onclick = () => { try { ensureUnlocked(); profileForm(); } catch(e){ toast('Unlock first','error'); } };
    $('#btnLock').onclick = () => lockVault();

    $('#btnExport').onclick = async () => {
      try { ensureUnlocked(); } catch(e) { toast('Unlock first','error'); return; }
      const payload = localStorage.getItem(VAULT_KEY);
      const meta = localStorage.getItem(META_KEY);
      const blob = new Blob([JSON.stringify({meta: JSON.parse(meta), data: JSON.parse(payload)}, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `vault-encrypted-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      toast('Exported encrypted vault','ok');
    };

    $('#btnImport').onclick = async () => {
      const input = document.createElement('input');
      input.type = 'file'; input.accept = 'application/json';
      input.onchange = async () => {
        const file = input.files[0]; if (!file) return;
        const txt = await file.text();
        try {
          const obj = JSON.parse(txt);
          if (!obj.data || !obj.meta) throw new Error('Invalid file');
          localStorage.setItem(VAULT_KEY, JSON.stringify(obj.data));
          localStorage.setItem(META_KEY, JSON.stringify(obj.meta));
          toast('Imported. Please unlock with the corresponding master password.');
          lockVault();
        } catch(err) {
          toast('Import failed: ' + err.message, 'error');
        }
      };
      input.click();
    };

    $('#itemList').addEventListener('click', async (e) => {
      const btn = e.target.closest('button'); if (!btn) return;
      const id = btn.getAttribute('data-id');
      const action = btn.getAttribute('data-action');
      const list = vault.profiles[activeProfile] || [];
      const it = list.find(x=>x.id===id);
      if (!it) return;
      touch();
      if (action==='copy') {
        await navigator.clipboard.writeText(it.password);
        toast('Password copied','ok');
      } else if (action==='reveal') {
        const span = document.querySelector(`[data-pw="${id}"]`);
        if (!span) return;
        const showing = span.textContent.startsWith('•');
        span.textContent = showing ? it.password : '•'.repeat(12);
        if (!showing) span.textContent = '•'.repeat(12);
      } else if (action==='del') {
        const ok = await confirmDialog({title:'Delete entry?', message:`This cannot be undone.`, okText:'Delete', cancelText:'Cancel'});
        if (!ok) return;
        vault.profiles[activeProfile] = list.filter(x => x.id!==id);
        await persistVault();
        renderItems();
        toast('Deleted','ok');
      } else if (action==='edit') {
        itemForm(it);
      }
    });

    $('#search').addEventListener('input', () => { renderItems(); });
    $('#btnClearSearch').onclick = () => { $('#search').value=''; renderItems(); };

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key==='Escape') lockVault();
      if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k') { e.preventDefault(); $('#search').focus(); }
      if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='n') { e.preventDefault(); $('#btnNewItem').click(); }
    });

    // Auto-lock timer
    setInterval(() => {
      const sel = $('#autolock').value|0;
      if (!sel || !vault) return;
      if (Date.now() - lastActive > sel) { toast('Auto-locked'); lockVault(); }
    }, 5000);
    document.addEventListener('pointerdown', touch, {passive:true});
    document.addEventListener('keydown', touch);

    // Auth UI
    $('#btnGoSetup').onclick = () => { $('#loginForm').hidden = true; $('#setupForm').hidden = false; };
    $('#btnBackLogin').onclick = () => { $('#setupForm').hidden = true; $('#loginForm').hidden = false; };

    $('#btnUnlock').onclick = async () => {
      const pw = $('#masterPassword').value;
      try { await loadVault(pw); toast('Unlocked','ok'); $('#masterPassword').value=''; } catch(err){ toast('Wrong password or no vault found','error'); }
    };

    function escapeHtml(s) { return (s||'').replace(/[&<>"]+/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[ch]||ch)); }

    $('#setupPass').addEventListener('input', () => {
      const s = passwordStrength($('#setupPass').value);
      $('#strengthBar').style.width = (s*100/22) + '%';
    });

    $('#btnCreateVault').onclick = async () => {
      const a = $('#setupPass').value, b = $('#setupPass2').value;
      if (!a || a!==b) { toast(!a? 'Enter a password' : 'Passwords do not match','error'); return; }
      await createVault(a);
      $('#setupPass').value = $('#setupPass2').value = '';
      toast('Vault created','ok');
    };

    // Initial state: show login or blur
    (function init(){
      const exists = !!localStorage.getItem(VAULT_KEY);
      $('#authScreen').hidden = false;
      $('#mainBody').hidden = true;
      if (!exists) { $('#loginForm').hidden = true; $('#setupForm').hidden = false; }
      setBlur(true);
    })();
  </script>

  <!--
    IMPORTANT SECURITY NOTES (readme-style):
    - This is a purely client-side demo. It encrypts your data with AES-GCM using a key derived
      from your master password (PBKDF2). The encrypted blob is stored in localStorage.
    - If you forget your master password, the data cannot be recovered.
    - Browsers can clear localStorage (e.g., private mode, clearing site data). Export your encrypted vault regularly.
    - For real-world use, prefer a vetted, audited password manager. This demo is for educational purposes.
  -->
</body>
</html>
